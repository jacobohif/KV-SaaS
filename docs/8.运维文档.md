# 8. 运维文档 (Operations & Maintenance Documentation)

本手册为SaaS平台的运维和技术支持团队提供指导，涵盖部署、监控、维护和灾难恢复等关键操作。

---

### **1. 系统部署 (Deployment)**

#### **1.1 部署架构与工具**

*   **容器化**: 所有服务均打包为 **Docker** 镜像。
*   **容器编排**: 生产环境采用 **Kubernetes (K8s)** 进行部署和管理。
*   **配置管理**: 使用 **Helm Charts** 对K8s部署配置进行版本化管理。
*   **镜像仓库**: 使用 **Docker Hub**, **AWS ECR**, 或 **Harbor** 等私有/公有镜像仓库。

#### **1.2 CI/CD 部署流程**

```mermaid
graph TD
    subgraph "开发阶段"
        A[1. 开发者提交代码到特性分支] --> B{2. 创建合并请求 (Pull Request)};
    end

    subgraph "自动化 CI/CD 流水线 (GitHub Actions / GitLab CI)"
        B --> C[3. 自动触发 CI];
        C --> D["- 运行单元测试<br>- 运行集成测试<br>- 代码质量扫描 (Clippy)"];
        D -- 失败 --> X[通知开发者修复];
        D -- 成功 --> E[4. 构建 Docker 镜像];
        E --> F[5. 推送镜像到仓库];
        F --> G[6. 自动部署到<br><b>测试 (QA) 环境</b>];
        G --> H[- 运行自动化 E2E 测试];
        H -- 失败 --> X;
    end

    subgraph "发布阶段"
        H -- 成功 --> I{7. <b>手动门禁:</b><br>QA团队/产品负责人<br>在测试环境验证};
        I -- 不通过 --> X;
        I -- 通过 --> J[8. 自动部署到<br><b>预生产 (Staging) 环境</b>];
        J --> K{9. <b>手动门禁:</b><br>进行最终回归测试<br>或向相关方演示};
        K -- 不通过 --> X;
        K -- 通过 --> L[10. <b>手动触发</b><br>部署到<b>生产环境</b>];
        L --> M[11. 采用<b>金丝雀发布</b><br>逐步将流量切换到新版本];
    end

    classDef manual fill:#F59E0B,color:#fff,stroke:#B45309;
    class I,K,L manual;
```

#### **1.3 关键操作命令示例**

*   **构建与推送镜像**:
    ```bash
    # 1. 登录到镜像仓库
    docker login your-registry.com

    # 2. 构建镜像 (假设Dockerfile在当前目录)
    # 使用Git提交哈希作为标签，保证可追溯性
    export IMAGE_TAG=$(git rev-parse --short HEAD)
    docker build -t your-registry.com/your-app:$IMAGE_TAG .

    # 3. 推送镜像
    docker push your-registry.com/your-app:$IMAGE_TAG
    ```

*   **使用Helm部署或升级**:
    ```bash
    # 假设Helm Chart位于 ./charts/your-app
    # 更新Helm依赖
    helm dependency update ./charts/your-app

    # 部署或升级应用
    # --install: 如果应用不存在则安装
    # -n: 指定命名空间
    # -f: 指定自定义的values文件
    helm upgrade --install your-app-release ./charts/your-app \
      -n your-namespace \
      -f ./charts/your-app/values.staging.yaml \
      --set image.tag=$IMAGE_TAG
    ```

*   **查看部署状态**:
    ```bash
    # 查看Pod状态
    kubectl get pods -n your-namespace

    # 查看应用日志 (选择一个Pod)
    kubectl logs -f your-app-pod-name -n your-namespace

    # 如果Pod启动失败，查看其详细描述以排查问题
    kubectl describe pod your-app-pod-name -n your-namespace
    ```

---

### **2. 监控、日志与告警**

#### **2.1 监控体系与核心仪表盘**

*   **工具栈**: **Prometheus** (指标收集) + **Grafana** (可视化)。
*   **核心理念**: 监控应服务于快速发现问题、定位问题和容量规划。我们为不同层面创建专门的仪表盘。

*   **Grafana仪表盘 1: 全局业务概览 (Global Business Overview)**
    *   **用途**: 供管理层和产品负责人快速了解平台健康状况。
    *   **关键指标**:
        *   `Stat`: 活跃租户总数、总用户数、当前总订阅收入(MRR)。
        *   `Graph`: 新用户/新租户增长趋势图 (按天/周)。
        *   `Table`: Top 10 活跃租户列表 (按API调用次数)。

*   **Grafana仪表盘 2: 应用性能监控 (APM)**
    *   **用途**: 供开发和运维团队监控应用健康度。
    *   **关键指标 (RED Method)**:
        *   **Rate (请求速率)**: 各API端点的QPS (每秒查询率)。
        *   **Errors (错误率)**: HTTP 5xx 和 4xx 错误率。
        *   **Duration (响应时长)**: API 响应时间的 P99, P95, P50 分位数。
        *   **其他**: 应用CPU/内存使用率、数据库连接池状态。

*   **Grafana仪表盘 3: 基础设施监控 (Infrastructure)**
    *   **用途**: 供运维团队监控底层资源。
    *   **关键指标**:
        *   **K8s集群**: Node/Pod健康状态、CPU/内存/磁盘使用率。
        *   **PostgreSQL**: 连接数、活跃查询、慢查询数量、复制延迟。
        *   **Redis**: 内存使用、命中率、连接数。

#### **2.2 日志管理**

*   **工具栈**: **Loki** + **Fluentd** (推荐，与Prometheus/Grafana生态集成度高) 或 **ELK Stack**。
*   **日志格式**: 所有应用日志必须以 **JSON** 格式输出到标准输出 (stdout)。
*   **核心字段**: 每条日志都必须包含 `timestamp`, `level`, `service_name`, `trace_id`, `tenant_id` (如果适用)，以便于筛选和分析。
*   **查询**: 运维人员通过Grafana Explore或Kibana，可以进行高效的日志查询。

#### **2.3 告警管理**

*   **工具**: **Alertmanager**。
*   **告警分级**:
    *   **P1 (紧急/唤醒告警)**: 需要立即处理，直接电话或短信通知On-Call工程师。
        *   规则示例: 生产环境API错误率 > 5% 持续5分钟；数据库主库宕机。
    *   **P2 (警告)**: 需要关注，但无需立即处理，发送到Slack告警频道。
        *   规则示例: 预生产环境部署失败；节点磁盘空间将在24小时内耗尽。
    *   **P3 (信息)**: 日常信息，如部署成功通知。
*   **通知渠道**: PagerDuty (P1), Slack (P2), Email (P3)。

---

### **3. 标准操作流程 (SOPs)**

本章节定义了关键运维操作的标准化流程，以确保操作的准确性、可重复性和安全性。

#### **SOP-01: 数据库备份恢复演练**

*   **目的**: 验证数据库备份的有效性，并确保团队熟悉恢复流程。
*   **频率**: 每季度一次。
*   **流程**:
    1.  **准备**:
        *   从生产环境获取最新的数据库全量备份文件。
        *   准备一个临时的、与生产环境隔离的K8s命名空间和一台新的PostgreSQL实例。
    2.  **执行**:
        *   将备份文件恢复到新的PostgreSQL实例中。
        *   记录恢复过程所花费的时间。
    3.  **验证**:
        *   启动一个临时的应用实例，连接到恢复后的数据库。
        *   执行一系列预定义的只读API调用，验证核心数据（如用户数、项目数）是否完整、一致。
        *   随机抽取几个租户的数据进行抽样检查。
    4.  **清理**:
        *   销毁临时环境和恢复的数据库实例。
    5.  **报告**:
        *   编写演练报告，记录恢复时间、验证结果和遇到的任何问题。

#### **SOP-02: 生产环境数据库主从切换 (手动)**

*   **场景**: 主数据库实例发生不可逆转的故障，且自动故障转移失败。
*   **前提**:
    *   已收到P1级告警“数据库主库不可用”。
    *   已确认备库(Replica)数据同步延迟在可接受范围内（< 1分钟）。
*   **流程**:
    1.  **宣告事件**: 在Slack #oncall 频道宣告开始进行数据库主从切换，并创建一个事件作战室。
    2.  **应用层隔离**: 暂时将应用部署的副本数缩减为0，或通过网络策略阻止应用访问数据库，防止脏数据写入。
    3.  **提升备库**: 执行云服务商或数据库管理工具提供的“提升备库为新主库”命令。
    4.  **更新连接字符串**: 在应用的配置中心（如K8s ConfigMap/Secret）中，将数据库连接地址更新为新主库的地址。
    5.  **恢复应用**: 重新将应用副本数扩展回正常水平。
    6.  **功能验证**:
        *   观察Grafana仪表盘，确认API错误率恢复正常。
        *   手动测试核心功能（如登录、创建数据）是否正常。
    7.  **宣告结束**: 在作战室中宣告事件结束，并安排事后复盘。

### **4. 灾难恢复 (Disaster Recovery)**

*   **核心目标**:
    *   **RPO (恢复点目标)**: < 15分钟。
    *   **RTO (恢复时间目标)**: < 1小时。
*   **架构保障**:
    *   **多可用区部署**: 生产环境的所有组件（K8s节点、数据库实例）均跨多个可用区（AZ）部署。
    *   **基础设施即代码 (IaC)**: 使用Terraform或Pulumi管理所有云资源，确保可以快速、可重复地重建整个环境。
*   **恢复预案**:
    *   **场景1: 单个Pod/节点故障**: K8s自动处理，无需人工干预。
    *   **场景2: 单个可用区(AZ)故障**:
        *   **预案**: K8s调度器会自动将受影响的Pod在其他健康的AZ中重新创建。负载均衡器(Load Balancer)的健康检查会自动将流量从故障AZ中摘除。
        *   **需人工介入**: 检查数据库是否已自动完成主从切换。如未自动切换，则执行 **SOP-02**。
    *   **场景3: 区域级(Region)故障 (极端情况)**:
        *   **预案**: 启动异地灾备恢复流程，使用异地备份在另一个区域重建整个环境。这是一个高成本、复杂的过程，需要根据业务的SLA（服务等级协议）来决定是否实施。
